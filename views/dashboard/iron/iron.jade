extends ./layout
block page-body
  .panel.panel-default.order-panel
    .panel-body
      h4 #{__('Order')} #{__('List')}
      table.table.table-bordered.table-striped.table-hover.js-basic-example.order-table.dataTable
        thead
          tr
            th #{__('Date')}
            th #{__('Handler')}
            th #{__('File')}#
            th #{__('Buyer')}
            th #{__('Style')}
            th #{__('Product')}
            th #{__('Season')}
            th #{__('Quantity')}
        tbody
  - for(var ppp = 0; ppp < role.length; ppp++){
    - if(role[ppp].page == 8 && role[ppp].w == 1){
        .panel.panel-default.add-iron-panel(style='display:none;')
          .panel-heading
            | #{__('Add')} #{__('Iron')}
          .panel-body
            form.add-form
              input(type="hidden").order-id
              .form-group.clearfix.col-md-2
                label.display-block #{__('Style')}
                select.select-bar.new-style(style='width: 100%;')
                  option(value='-1') Not Selected            
              .form-group.clearfix.col-md-2
                label.display-block #{__("COLOR")}
                select.select-bar.new-color(style='width: 100%;')
                  option(value='-1') Not Selected
              .form-group.clearfix.col-md-2
                label.display-block #{__("COLOR CODE")}
                select.select-bar.new-colorcode(style='width: 100%;')
                  option(value='-1') Not Selected
              .form-group.clearfix.col-md-2
                label.display-block #{__('DATE')}
                input.form-control.new-date(type='text', placeholder='Please choose a date...', data-format='YYYY-MM-DD')
              .form-group.clearfix.col-md-2
                label.display-block #{__('INVOICE')}#
                input.form-control.new-invoice(type='text', placeholder='INVOICE#', required)
              .form-group.clearfix.col-md-2.size-1
                label.display-block #{__('Size')}1
                input.form-control.new-size-1(type='text', placeholder='')
              .form-group.clearfix.col-md-2.size-2
                label.display-block #{__('Size')}2
                input.form-control.new-size-2(type='text', placeholder='')
              .form-group.clearfix.col-md-2.size-3
                label.display-block #{__('Size')}3
                input.form-control.new-size-3(type='text', placeholder='')
              .form-group.clearfix.col-md-2.size-4
                label.display-block #{__('Size')}4
                input.form-control.new-size-4(type='text', placeholder='')
              .form-group.clearfix.col-md-2.size-5
                label.display-block #{__('Size')}5
                input.form-control.new-size-5(type='text', placeholder='')
              .form-group.clearfix.col-md-2.size-6
                label.display-block #{__('Size')}6
                input.form-control.new-size-6(type='text', placeholder='')
              .form-group.clearfix.col-md-2.size-7
                label.display-block #{__('Size')}7
                input.form-control.new-size-7(type='text', placeholder='')
              .form-group.clearfix.col-md-2.size-8
                label.display-block #{__('Size')}8
                input.form-control.new-size-8(type='text', placeholder='')
              .form-group.clearfix.col-md-2.size-9
                label.display-block #{__('Size')}9
                input.form-control.new-size-9(type='text', placeholder='')
              .form-group.clearfix.col-md-2.size-10
                label.display-block #{__('Size')}10
                input.form-control.new-size-10(type='text', placeholder='')              
              .form-group.col-md-12
                button.btn.btn-sm.btn-success.pull-right(type='submit') #{__('Add')} #{__('Iron')}
        .panel.panel-default.update-iron-panel(style='display:none;')
          .panel-heading
            | #{__('Update')} #{__('Iron')}
          .panel-body
            form.update-form
              input(type="hidden").order-id
              input(type='hidden').old-id
              .form-group.clearfix.col-md-2
                label.display-block #{__('Style')}
                select.select-bar.update-style(style='width: 100%;')
                  option(value='-1') Not Selected            
              .form-group.clearfix.col-md-2
                label.display-block #{__("COLOR")}
                select.select-bar.update-color(style='width: 100%;')
                  option(value='-1') Not Selected            
              .form-group.clearfix.col-md-2
                label.display-block #{__("COLOR CODE")}
                select.select-bar.update-colorcode(style='width: 100%;')
                  option(value='-1') Not Selected
              .form-group.clearfix.col-md-2
                label.display-block #{__('DATE')}
                input.form-control.update-date(type='text', placeholder='Please choose a date...', data-format='YYYY-MM-DD')
              .form-group.clearfix.col-md-2
                label.display-block #{__('INVOICE')}#
                input.form-control.update-invoice(type='text', placeholder='INVOICE#', required)
              .form-group.clearfix.col-md-2.size-1
                label.display-block #{__('Size')}1
                input.form-control.update-size-1(type='text', placeholder='')
              .form-group.clearfix.col-md-2.size-2
                label.display-block #{__('Size')}2
                input.form-control.update-size-2(type='text', placeholder='')
              .form-group.clearfix.col-md-2.size-3
                label.display-block #{__('Size')}3
                input.form-control.update-size-3(type='text', placeholder='')
              .form-group.clearfix.col-md-2.size-4
                label.display-block #{__('Size')}4
                input.form-control.update-size-4(type='text', placeholder='')
              .form-group.clearfix.col-md-2.size-5
                label.display-block #{__('Size')}5
                input.form-control.update-size-5(type='text', placeholder='')
              .form-group.clearfix.col-md-2.size-6
                label.display-block #{__('Size')}6
                input.form-control.update-size-6(type='text', placeholder='')
              .form-group.clearfix.col-md-2.size-7
                label.display-block #{__('Size')}7
                input.form-control.update-size-7(type='text', placeholder='')
              .form-group.clearfix.col-md-2.size-8
                label.display-block #{__('Size')}8
                input.form-control.update-size-8(type='text', placeholder='')
              .form-group.clearfix.col-md-2.size-9
                label.display-block #{__('Size')}9
                input.form-control.update-size-9(type='text', placeholder='')
              .form-group.clearfix.col-md-2.size-10
                label.display-block #{__('Size')}10
                input.form-control.update-size-10(type='text', placeholder='')              
              .form-group.col-md-12
                button.btn.btn-sm.btn-success.pull-right(type='submit') #{__('Update')} #{__('Iron')}
                - if(role[ppp].page == 8 && role[ppp].d == 1){
                  .btn.btn-sm.btn-success.pull-right.remove(style='margin-right: 20px;') #{__('Remove')} #{__('Iron')}
                - }
    - }
  - }  
  .panel.panel-default.iron-list-panel(style='display:none;')
    .panel-heading
      | #{__('IRON')}
    .panel-body
      .align-justify
        - for(var ppp = 0; ppp < role.length; ppp++){
          - if(role[ppp].page == 8 && role[ppp].w == 1){
              .p-b-10
                button.btn.btn-sm.btn-success.add-iron
                  i.fa.fa-plus.m-r-5
                  | #{__('Add')} #{__('New')} #{__('Iron')}
          - }
        - }
        table#mainTable.table.table-bordered.table-striped.detailview
          thead.bg-blue-grey
            tr
              th(rowspan='2', width='100').text-center #{__('STYLE')}#
              th(rowspan='2', width='100').text-center #{__('COLOR')}
              th(rowspan='2', width='200').text-center
                | #{__('COLOR')} #{__('CODE')}#
              th(rowspan='2', width='100').text-center #{__('DATE')}
              th(rowspan='2', width='100').text-center #{__('INVOICE')}
              th.align-center.size-header-span.text-center #{__('SIZE')}
              th(rowspan='2').text-center #{__('TOTAL')}
            tr.sizeheader
          tbody
block script2
  script.
    var tasks, orderftypes, allcustomers = (!{JSON.stringify(allcustomers)}), buyer, name, irondata;

    function init(){          
      $('.new-shipdate').datetimepicker({
        format: 'YYYY-MM-DD',
        showClear: true
      });
      $('.new-date').datetimepicker({
        format: 'YYYY-MM-DD',
        showClear: true
      });
      $('.new-style').select2();
      $('.new-color').select2();
      $('.new-colorcode').select2();
      var b1 = true;
      var b2 = true;
      $('.new-color').on('change', function(){
        if(b2){
          b1 = false;
          $('.new-colorcode').val($(this).val()).trigger('change');        
        }
        b2 = true;
      })
      $('.new-colorcode').on('change', function(){
        if(b1){
          b2 = false;
          $('.new-color').val($(this).val()).trigger('change');
        }
        b1 = true;
      })

      $('.update-shipdate').datetimepicker({
        format: 'YYYY-MM-DD',
        showClear: true
      });
      $('.update-date').datetimepicker({
        format: 'YYYY-MM-DD',
        showClear: true
      });
      $('.update-style').select2();
      $('.update-color').select2();
      $('.update-colorcode').select2();
      var b1 = true;
      var b2 = true;
      $('.update-color').on('change', function(){
        if(b2){
          b1 = false;
          $('.update-colorcode').val($(this).val()).trigger('change');        
        }
        b2 = true;
      })
      $('.update-colorcode').on('change', function(){
        if(b1){
          b2 = false;
          $('.update-color').val($(this).val()).trigger('change');
        }
        b1 = true;
      })

      $('.add-iron-panel').on('click', 'a.panel-close', function () {
        $(this).parents('.add-iron-panel').fadeOut();
      });
      $('.update-iron-panel').on('click', 'a.panel-close', function () {
        $(this).parents('.update-iron-panel').fadeOut();
      });
      $('.add-iron').on('click', function(){
        $('.add-iron-panel').fadeIn();
        $('.update-iron-panel').fadeOut();
      })
    }

    init();

  
    $('.search-form').submit(function(e){
      e.preventDefault();
      var startdate = $('.in-date').val().split('-')[0];
      var enddate = $('.in-date').val().split('-')[1];

      $('.lds-spinner').fadeIn();
      $.ajax({
        url: '/dashboard/iron/search',
        type: 'POST',
        data: {
          buyer: $('.buyer').val(),
          startdate: startdate,
          enddate: enddate,
          color: $('.color').val(),
          po: $('.po').val(),
          style: $('.style').val()
        },
        success: function(result){
          $('.lds-spinner').fadeOut();
          if(result.isSuccess){
            console.log(result.list);
            fillOrderTable(result.list);
            $('.iron-list-panel').hide();
          }else{
            alert('Cannot search.');
          }
        }
      })
    })

    var fillOrderTable = function(list){
      $('.order-panel').show();
      var tableData = [];
      for(let i = 0; i < list.length; i++){
        tableData.push([
          list[i].date.split('T')[0], list[i].handlername, list[i].name, list[i].buyername, list[i].style, list[i].product, list[i].season, list[i].quantity
        ])
      }
      $('.order-table').dataTable().fnClearTable();
      if(tableData.length > 0){
        $('.order-table').dataTable().fnAddData(tableData);
        $('.order-table').dataTable().fnDraw();
      }
      refreshEvent();
    }

    var orderdata;

    var refreshEvent = function(){
      $('.order-table tbody tr').off();
      $('.order-table tbody tr').on('click', function(){
        $('.iron-list-panel').show();

        name = $($(this).find('td')[2]).html();        
        buyer = $($(this).find('td')[3]).html();

        $.ajax({
          url: '/dashboard/iron/order_detail',
          type: 'POST',
          data: {
            name: name,
            buyer: buyer
          },
          success: function(data){
            if(data.isSuccess){
              console.log(data);
              orderdata = data;
              var ht = '', len = 0;
              for(var i = 1; i < 11; i++){
                if(data.sizegroup['size'+i] != -1){
                  for(var j = 0; j < data.sizes.length; j++){
                    if(data.sizes[j].id == data.sizegroup['size'+i]){
                      len++;
                      ht += `<th width = "60">`+data.sizes[j].name+`</th>`;
                      $('.size-'+i+'>label').html(data.sizes[j].name);
                    }
                  }
                  $('.size-'+i).show();                  
                }else{
                  $('.size-'+i).hide();
                }
              }
              $('.sizeheader').html(ht);
              $('.size-header-span').attr('colspan',len);

              $(".new-style").select2("destroy");
              $('.new-style').html("");
              $('.new-style').append(
                  '<option value="-1">Not Selected</option>'
              );
              var tmp = [];
              $.each(data.orderdetails, function(index, value) {
                if(!tmp.includes(data.orderdetails[index].style)){
                  tmp.push(data.orderdetails[index].style);
                  $('.new-style').append(
                    '<option value="' + data.orderdetails[index].style + '">' + data.orderdetails[index].style + '</option>'
                  );
                }
              });
              $(".new-style").select2();

              $(".new-color").select2("destroy");
              $('.new-color').html("");
              $('.new-color').append(
                  '<option value="-1">Not Selected</option>'
              );
              var colorname = [];
              for(var index = 0; index < data.orderdetails.length; index++){
                if(!colorname.includes(data.orderdetails[index].colorname)){
                  
                  $('.new-color').append(
                    '<option value="' + data.orderdetails[index].color + '">' + data.orderdetails[index].colorname + '</option>'
                  );
                  colorname.push(data.orderdetails[index].colorname);
                }
              }
              $(".new-color").select2();

              $(".new-colorcode").select2("destroy");
              $('.new-colorcode').html("");
              $('.new-colorcode').append(
                  '<option value="-1">Not Selected</option>'
              );
              var colorcode = [];
              for(var index = 0; index < data.orderdetails.length; index++) {
                if(!colorcode.includes(data.orderdetails[index].color)){
                  $('.new-colorcode').append(
                    '<option value="' + data.orderdetails[index].color + '">' + data.orderdetails[index].color + '</option>'
                  );
                  colorcode.push(data.orderdetails[index].color);
                }                
              };
              $(".new-colorcode").select2();

              // Update Form
              $('.update-style').select2("destroy");
              $('.update-style').html("");
              $('.update-style').append(
                  '<option value="-1">Not Selected</option>'
              );
              var tmp = [];
              $.each(data.orderdetails, function(index, value) {
                if(!tmp.includes(data.orderdetails[index].style)){
                  tmp.push(data.orderdetails[index].style);
                  $('.update-style').append(
                    '<option value="' + data.orderdetails[index].style + '">' + data.orderdetails[index].style + '</option>'
                  );
                }
              });
              $(".update-style").select2();

              $(".update-color").select2("destroy");
              $('.update-color').html("");
              $('.update-color').append(
                  '<option value="-1">Not Selected</option>'
              );
              var colorname = [];
              for(var index = 0; index < data.orderdetails.length; index++){
                if(!colorname.includes(data.orderdetails[index].colorname)){
                  
                  $('.update-color').append(
                    '<option value="' + data.orderdetails[index].color + '">' + data.orderdetails[index].colorname + '</option>'
                  );
                  colorname.push(data.orderdetails[index].colorname);
                }
              }
              $(".update-color").select2();

              $(".update-colorcode").select2("destroy");
              $('.update-colorcode').html("");
              $('.update-colorcode').append(
                  '<option value="-1">Not Selected</option>'
              );
              var colorcode = [];
              for(var index = 0; index < data.orderdetails.length; index++) {
                if(!colorcode.includes(data.orderdetails[index].color)){
                  $('.update-colorcode').append(
                    '<option value="' + data.orderdetails[index].color + '">' + data.orderdetails[index].color + '</option>'
                  );
                  colorcode.push(data.orderdetails[index].color);
                }                
              };
              $(".update-colorcode").select2();

              loadIronData();
            }else{
              alert('Cannot load order data.');
            }
          }
        });
      });
    }

    var loadIronData = function(){
      $('.lds-spinner').fadeIn();
      $('.update-iron-panel').fadeOut();
      $('.add-iron-panel').fadeOut();
      $.ajax({
        url: '/dashboard/iron/list',
        type: 'POST',
        data: {
          orderid: orderdata.order.id
        },
        success: function(result){
          $('.lds-spinner').fadeOut();
          if(result.isSuccess){
            irondata = result.iron;
            var ht = '', all = 0;
            /********************* ORDER NUMBER(First Row) ************************/
            ht += '<tr style="background: #f5f3df"><td class="StringData text-center">ORDER<td><td/><td/><td/>';
            for(var i = 1; i < 11; i++){
              if(orderdata.sizegroup['size'+i] != -1){
                ht += '<td class="StringData text-center">' + result.order[i] + '</td>';
                all += result.order[i];
              }
            }
            ht += '<td class="StringData text-center">' + all + '</td></tr>';
            /********************* ORDER NUMBER(First Row) ************************/

            all = 0;
            /********************* CUT NUMBER(Second Row) ************************/
            ht += '<tr style="background: #e6e8fc"><td class="StringData text-center">CUT<td><td/><td/><td/>';
            for(var i = 1; i < 11; i++){
              if(orderdata.sizegroup['size'+i] != -1){
                ht += '<td class="StringData text-center">' + result.cut[i] + '</td>';
                all += result.cut[i];
              }
            }
            ht += '<td class="StringData text-center">' + all + '</td></tr>';
            /********************* CUT NUMBER(Second Row) ************************/

            /************************* SEW NUMBER(Third Row) *******************************/
            all = 0;
            ht += '<tr style="background: #f5f3df"><td class="StringData text-center">SEW<td><td/><td/><td/>';
            for(var i = 1; i < 11; i++){
              if(orderdata.sizegroup['size'+i] != -1){
                var b = false;
                for(var j = 0; j < result.sew.length; j++){
                  if(result.sew[j].id == orderdata.sizegroup['size'+i]){
                    ht += '<td class="StringData text-center">' + result.sew[j].amount + '</td>';
                    b = true;
                    all += Number(result.sew[j].amount);
                  }                  
                }
                if(!b){
                  ht += '<td class="StringData text-center">0</td>';
                }
              }
            }
            ht += '<td class="StringData text-center">' + all + '</td></tr>';
            /************************* SEW NUMBER(Third Row) *******************************/

            var total = [], bexist = [];
            all = 0;

            var startdate = $('.in-date').val().split('-')[0];
            var enddate = $('.in-date').val().split('-')[1];
            irondata = irondata.filter(v => {
              return (new Date(v.date) >= new Date(startdate) && new Date(v.date) <= new Date(enddate))
            })

            for(var i = 1; i < 11; i++){
              total[i] = 0;
              bexist[i] = false;
            }

            for(var i = 0; i < irondata.length; i++){
              ht += '<tr>';              
              ht += '<td class="StringData text-center">'+ irondata[i].style+'</td>';
              ht += '<td class="StringData text-center">'+ irondata[i].colorname+'</td>';
              ht += '<td class="StringData text-center">'+ irondata[i].color+'</td>';
              ht += '<td class="StringData text-center">'+ irondata[i].date + '</td>';
              ht += '<td class="StringData text-center">'+ irondata[i].invoice + '</td>';
              var sum = 0;
              for(var j = 1; j < 11; j++){
                if(orderdata.sizegroup['size'+j] != -1){
                  sum += Number(irondata[i]['size'+j]);
                  ht += '<td class="NumericData text-center">'+ irondata[i]['size'+j] + '</td>';

                  total[j] += Number(irondata[i]['size'+j]);
                  bexist[j] = true;
                }
              }
              ht += '<td class="text-center">'+sum+'</td>';
              ht + '</tr>';
              
              all += sum;
            }

            //Total
            if(irondata.length > 0){
              ht += '<tr><td class="text-center">Total</td><td></td><td></td><td></td><td></td>';
              for(var j = 1; j < 11; j++){
                if(total[j] != 0 && bexist[j] == true){
                  ht += '<td class="NumericData text-center">'+ total[j] + '</td>';
                }else if(bexist[j] == true && total[j] == 0){
                  ht += '<td></td>';
                }
              }
              ht += '<td class="text-center">'+all+'</td>';
              ht += '</tr>';
            }

            //Balance
            if(irondata.length > 0){
              ht += '<tr><td class="text-center">Balance</td><td></td><td></td><td></td><td></td>';
              for(var j = 1; j < 11; j++){
                if(total[j] != 0 && bexist[j] == true){
                  ht += '<td class="NumericData text-center">'+ (-result.order[j] + total[j]) + '</td>';
                }else if(bexist[j] == true && total[j] == 0){
                  ht += '<td class="NumericData text-center">'+ (-result.order[j]) + '</td>';
                }
              }
              ht += '<td class="text-center">'+all+'</td>';
              ht += '</tr>';
            }

            $('.iron-list-panel tbody').html(ht);
            refreshTableEvent();
          }else{
            alert('Cannot load Iron data');        
          }
        }
      })
    }

    var refreshTableEvent = function(){
      $('.iron-list-panel tbody tr').on('click', function(){
        $('.update-iron-panel').fadeIn();
        $('.add-iron-panel').fadeOut();
                
        var style = $($(this).find('td')[0]).html();
        var invoice = $($(this).find('td')[4]).html();
        var color = $($(this).find('td')[2]).html();
        console.log(irondata);
        console.log(style, invoice, color);        
        for(var i = 0; i < irondata.length; i++){
          if(irondata[i].style == style && irondata[i].invoice == invoice && irondata[i].color == color){
            fillUpdateForm(irondata[i]);
          }
        }
      })
    }

    var fillUpdateForm = function(data){
      $('.update-style').val(data.style).trigger('change');
      $('.old-id').val(data.id);
      setTimeout(function(){
        $('.update-color').val(data.color).trigger('change');
      }, 500);
      $('.update-date').val(data.date);
      $('.update-invoice').val(data.invoice);
      $('.update-size-1').val(data.size1);
      $('.update-size-2').val(data.size2);
      $('.update-size-3').val(data.size3);
      $('.update-size-4').val(data.size4);
      $('.update-size-5').val(data.size5);
      $('.update-size-6').val(data.size6);
      $('.update-size-7').val(data.size7);
      $('.update-size-8').val(data.size8);
      $('.update-size-9').val(data.size9);
      $('.update-size-10').val(data.size10);      
    }

    $('.add-form').submit(function(e){
      e.preventDefault();      
      $.ajax({
        url: '/dashboard/iron/add',
        type: 'POST',
        data: {
          order: orderdata.order.id,
          style: $('.new-style').val(),
          color: $('.new-color').val(),
          colorname: $('.new-color').select2('data')[0].text,
          date: $('.new-date').val(),
          invoice: $('.new-invoice').val(),
          size1: $('.new-size-1').val(),
          size2: $('.new-size-2').val(),
          size3: $('.new-size-3').val(),
          size4: $('.new-size-4').val(),
          size5: $('.new-size-5').val(),
          size6: $('.new-size-6').val(),
          size7: $('.new-size-7').val(),
          size8: $('.new-size-8').val(),
          size9: $('.new-size-9').val(),
          size10: $('.new-size-10').val()
        },
        success: function(data){
          if(data.isSuccess){
            loadIronData();
            reset();
          }else{
            alert('There is already same Iron Invoice. Please check detail.');
          }
        }
      })
    })

    $('.update-form').submit(function(e){
      e.preventDefault();      
      $.ajax({
        url: '/dashboard/iron/update',
        type: 'POST',
        data: {
          order: orderdata.order.id,
          oldid: $('.old-id').val(),
          style: $('.update-style').val(),
          color: $('.update-color').val(),
          colorname: $('.update-color').select2('data')[0].text,
          date: $('.update-date').val(),
          invoice: $('.update-invoice').val(),
          size1: $('.update-size-1').val(),
          size2: $('.update-size-2').val(),
          size3: $('.update-size-3').val(),
          size4: $('.update-size-4').val(),
          size5: $('.update-size-5').val(),
          size6: $('.update-size-6').val(),
          size7: $('.update-size-7').val(),
          size8: $('.update-size-8').val(),
          size9: $('.update-size-9').val(),
          size10: $('.update-size-10').val()          
        },
        success: function(data){
          if(data.isSuccess){
            loadIronData();
            reset();
          }else{
            alert('Cannot save Iron data. Please check detail.');
          }
        }
      })
    })

    var reset = function(){
      $('.update-iron-panel').fadeOut();
      $('.new-date').val('');
      $('.new-invoice').val('');
      $('.new-size-1').val('');
      $('.new-size-2').val('');
      $('.new-size-3').val('');
      $('.new-size-4').val('');
      $('.new-size-5').val('');
      $('.new-size-6').val('');
      $('.new-size-7').val('');
      $('.new-size-8').val('');
      $('.new-size-9').val('');
      $('.new-size-10').val('');      
    }

    $('.remove').on('click', function(){
      $.ajax({
        url: '/dashboard/iron/delete',
        type: 'POST',
        data: {
          oldid: $('.old-id').val()
        },
        success: function(result){
          if(result.isSuccess){
            loadIronData();
          }else{
            alert('Cannot Delete Cut data.');
          }
        }
      })
    })

    $('.order-table').on( 'page.dt', function () {
      setTimeout(function(){
        refreshEvent();
      }, 500)
    });

    $('.order-table').on( 'search.dt', function () {
      setTimeout(function(){
        refreshEvent();
      }, 500)
    });