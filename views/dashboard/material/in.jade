extends ./layout
block page-header
  .page-heading
    h1 Material In
    ol.breadcrumb
      li
        a(href='../../index.html') Home
      li
        a(href='javascript:void(0);') Material IN
      li.active List
    
block page-body
  .panel.panel-default
    .panel-body
      h4 Order List
      table.table.table-bordered.table-striped.table-hover.js-basic-example.order-table.dataTable
        thead
          tr
            th Date
            th Handler
            th File#
            th Buyer
            th Style
            th Product
            th Season
            th Quantity
        tbody

  .panel.panel-default
    .row.clearfix
      .col-xs-12.col-sm-12.col-md-12.col-lg-12
        ul.nav.nav-tabs.bg-default          
        .tab-content
          #tab_.tab-pane.fade.in.active(role='tabpanel')
            .panel.panel-default.add-code
              .panel-heading Add Material
              .panel-body
                form.add-form
                  .form-group.clearfix.col-md-2
                    label.display-block Task PO
                    select.task-bar.select2(style='width: 100%;')
                      option(value='-1') Not Selected
                  .form-group.clearfix.col-md-2
                    label.display-block Ship Date
                    input.form-control.ship-date(type='text', required='', readonly)
                  .form-group.clearfix.col-md-2
                    label.display-block Color
                    input.form-control.color-name(type='text', required='', readonly)
                  .form-group.clearfix.col-md-2
                    label.display-block Size
                    select.size-bar.select2(style='width: 100%;')
                      option(value='-1') Not Selected
                      option(value='0') Inactive
                  .form-group.clearfix.col-md-2
                    label.display-block Order Number
                    input.form-control.order-number(type='text', placeholder='Order Number', required='', readonly)
                  .form-group.clearfix.col-md-2
                    label.display-block Loss(5%)
                    input.form-control.order-loss(type='text', placeholder='Total', required='', readonly)
                  .form-group.clearfix.col-md-2
                    label.display-block Need
                    input.form-control.need(type='text', placeholder='Need', required='', readonly)
                  .form-group.clearfix.col-md-2
                    label.display-block Rcvd#
                    input.form-control.rcvd(type='text', placeholder='rcvd', required='')                  
                  .form-group.clearfix.col-md-2
                    label.display-block Date
                    input.form-control.in-date(type='text', placeholder='In Date', required='')
                  .form-group.clearfix.col-md-2
                    label.display-block Customer
                    select.customer-bar.select2(style='width: 100%;')
                      option(value='-1') Not Selected
                      - for(var i = 0; i < allcustomers.length; i++){
                        option(value = '#{allcustomers[i].id}') #{allcustomers[i].name}
                      - }
                  .form-group.clearfix.col-md-2
                    label.display-block Invoice
                    input.form-control.invoice(type='text', placeholder='Invoice', required='')
                  .form-group.clearfix.col-md-2
                    label.display-block Quantity
                    input.form-control.quantity(type='text', placeholder='Quantity', required='')                  
                  .form-group.clearfix.col-md-12
                    button.btn.btn-sm.btn-success.pull-right(type='submit') Add Material            
            .panel.panel-default
              .panel-heading
                button.btn.btn-sm.btn-success
                  i.fa.fa-plus.m-r-5
                  | Add New Out
              .panel-body
                table.table.table-striped.table-hover.js-exportable.material-table
                  thead
                    tr
                      th Ship Date
                      th P.O
                      th Color
                      th Size
                      th Orden
                      th 5%
                      th Rcvd#
                      th Need
                      th Date
                      th Customer
                      th Invoice#
                      th Q'ty
                      th Total
                      th Balance
                      th %
                  tbody
                    tr
                      td(style='cursor:pointer;', data-toggle='modal', data-target='#ingreso')
                      td
                      td
                      td XXS
                      td 100
                      td 105
                      td 1
                      td 105
                      td 2018-03-24
                      td Customer
                      td 12345
                      td 30
                      td 30
                      td -75
                      td 28.57
                    tr
                      td(style='cursor:pointer;', data-toggle='modal', data-target='#ingreso')
                      td
                      td
                      td XS
                      td 0
                      td 0
                      td 1
                      td
                      td
                      td
                      td
                      td
                      td
                      td
                      td
                    tr
                      td(style='cursor:pointer;', data-toggle='modal', data-target='#ingreso')
                      td
                      td
                      td S
                      td 0
                      td 0
                      td 1
                      td
                      td
                      td
                      td
                      td
                      td
                      td
                      td
                    tr
                      td(style='cursor:pointer;', data-toggle='modal', data-target='#ingreso')
                      td
                      td
                      td M
                      td 0
                      td 0
                      td 1
                      td
                      td
                      td
                      td
                      td
                      td
                      td
                      td
                    tr
                      td(style='cursor:pointer;', data-toggle='modal', data-target='#ingreso')
                      td
                      td
                      td L
                      td 0
                      td 0
                      td 1
                      td
                      td
                      td
                      td
                      td
                      td
                      td
                      td
                    tr.primary
                      td 1 Sub-Total by PO & Color
                      td
                      td
                      td
                      td 100
                      td 105
                      td 105
                      td
                      td
                      td
                      td
                      td 30
                      td 30
                      td -75
                      td 28.57
                    tr
                      td(style='cursor:pointer;', data-toggle='modal', data-target='#ingreso') 2
                      td
                      td
                      td L
                      td 0
                      td 0
                      td 1
                      td
                      td
                      td
                      td
                      td
                      td
                      td
                      td
                    tr.success
                      td 3 Grand-Total
                      td
                      td
                      td
                      td 100
                      td 105
                      td 105
                      td
                      td
                      td
                      td
                      td 30
                      td 30
                      td -75
                      td 28.57
            
           
block script2  
  script.
    $('.order-table').DataTable({
      "pageLength": 25,
      responsive: true
    });

    $('.material-table').DataTable({
      "pageLength": 25,
      responsive: true,
      dom: '<"html5buttons"B>lTfgtip',
      buttons: ['copy', 'csv', 'excel', 'pdf', 'print']
    });
    
    var fillOrderTable = function(list){      
      var tableData = [];
      for(let i = 0; i < list.length; i++){
        tableData.push([
          list[i].date.split('T')[0], list[i].handlername, list[i].name, list[i].buyername, list[i].style, list[i].product, list[i].season, list[i].quantity
        ])
      }
      $('.order-table').dataTable().fnClearTable();
      if(tableData.length > 0){
        $('.order-table').dataTable().fnAddData(tableData);
        $('.order-table').dataTable().fnDraw();
      }
      refreshEvent();
    }
    
    var style;
    var refreshEvent = function(){
      $('.order-table tbody tr').off();
      $('.order-table tbody tr').on('click', function(){
        let name = $($(this).find('td')[2]).html();        
        let buyer =  $($(this).find('td')[3]).html();                
        style = $($(this).find('td')[4]).html();
        $.ajax({
          url: '/dashboard/material/order_material',
          type: 'POST',
          data: {
            name: name,
            buyer: buyer
          },
          success: function(data){
            if(data.isSuccess){
              var ht = '';
              for(var i = 0; i < data.product.length; i++){
                for(var j = 0; j < data.material.length; j++){
                  if(data.material[j].id == data.product[i]){
                    ht += '<li role="presentation">';
                    ht += '<a href = "#tab_'+'", data-toggle="tab", data-product="'+data.product[i]+'", data-buyer="'+buyer+'">'+data.material[j].name+'</a>';
                    ht += '</li>';                    
                  }
                }
              }
              for(var i = 0; i < data.finish.length; i++){
                for(var j = 0; j < data.material.length; j++){
                  if(data.material[j].id == data.finish[i]){
                    ht += '<li role="presentation">';
                    ht += '<a href = "#tab_'+'", data-toggle="tab", data-material="'+data.product[i]+'", data-buyer="'+buyer+'">'+data.material[j].name+'</a>';
                    ht += '</li>';
                  }
                }
              }
              $('.nav-tabs').html(ht);
              refreshTabEvent();
            }else{
              alert('Cannot load Material Headers');
            }
          }
        })
      })
    }


    $('.task-bar').select2();
    var tasks = [];
    var refreshTabEvent = function(){
      $.ajax({
        url: '/dashboard/material/material_task',
        type: 'POST',
        data: {
          style: style
        },
        success: function(data){
          if(data.isSuccess){
            $(".task-bar").select2("destroy");
            $('.task-bar').html("");
            $('.task-bar').append(
                '<option value="-1">Not Selected</option>'
            );              
            tasks = data.list;
            $.each(tasks, function(index, value) {
              $('.task-bar').append(
                '<option value="' + index + '">' + tasks[index].po + '</option>'
              );
            });
            $(".task-bar").select2();
            refreshTaskChangeEvent();
            loadSizeList();
          }else{
            alert('Cannot load Tasks.');
          }
        }
      })
      $('a[data-toggle="tab"]').off();
      $('a[data-toggle="tab"]').on('click', function(){
        
      })
    }

    var refreshTaskChangeEvent = function(){
      $('.task-bar').on('change', function(){
        let index = $(this).val();
        $('.ship-date').val(tasks[index].shipdate);
        $('.color-name').val(tasks[index].colorname);        
      })
    }

    $('.size-bar').select2();
    var loadSizeList = function(){
      $.ajax({
        url: '/dashboard/material/size_list',
        type: 'POST',
        data: {
          sizegroup: tasks[0].sizegroup
        },
        success: function(data){
          if(data.isSuccess){
            console.log(data);
            $(".size-bar").select2("destroy");
            $('.size-bar').html("");
            $('.size-bar').append(
                '<option value="-1">Not Selected</option>'
            );
            let sizes = data.list;
            $.each(sizes, function(index, value) {
              $('.size-bar').append(
                '<option value="' + sizes[index].id + '">' + sizes[index].name + '</option>'
              );
            });
            $(".size-bar").select2();
            refreshSizeChangeEvent();
          }else{
            alert('Cannot load SizeGroup');
          }
        }
      })
    }

    var refreshSizeChangeEvent = function(){
      $('size-bar').off();
      $('.size-bar').on('change', function(){
        let index = $('.size-bar').val();
        $('.order-number').val(tasks[0]['s'+index]);
        $('.need').val(tasks[0]['s'+index]);
      })
    }

    //In-Date
    $(".in-date").datetimepicker({
      format: 'YYYY-MM-DD',
      showClear: true
    });
    //
    $('.customer-bar').select2();