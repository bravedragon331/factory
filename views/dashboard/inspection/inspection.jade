extends ./layout

block page-body
  - for(var ppp = 0; ppp < role.length; ppp++){
    - if(role[ppp].page == 21 && role[ppp].w == 1){
        .panel.panel-default.add-panel(style='display:none;')
          .panel-heading
            | ADD DATA
          .panel-body
            form.add-form
              .row
                .form-group.clearfix.col-md-2
                  label.display-block Name
                  input.form-control.new-name(type='text', placeholder='Name', required)
                .form-group.clearfix.col-md-2
                  label.display-block DATE
                  input.form-control.new-date(type='text', placeholder='Please choose a date...', data-format='YYYY-MM-DD')
                .form-group.clearfix.col-md-2
                  label.display-block Buyer
                  select.select-bar.new-buyer(style='width:100%;')
                    option(value='-1') Not Selected
                    - for (var i = 0; i < customers.length; i++){
                        option(value='#{customers[i].id}') #{customers[i].name}
                    - }
                .form-group.clearfix.col-md-2
                  label.display-block FILE#
                  select.select-bar.new-order(style='width: 100%;')
                    option(value='-1') Not Selected
                    - for(var i = 0; i < orders.length; i++){
                        option(value = '#{orders[i].id}') #{orders[i].name}
                    - }                
                .form-group.clearfix.col-md-2
                  label.display-block COLOR
                  select.select-bar.new-color(style='width: 100%;')
                    option(value='-1') Not Selected
                    - for(var i = 0; i < colors.length; i++){
                        option(value = '#{colors[i].name}') #{colors[i].name}
                    - }
                .col-md-2(style="position: block; width:100%;")
                .form-group.clearfix.col-md-1
                  label.display-block 08:00
                  input.form-control.new-01(type='text', placeholder='08:00')
                .form-group.clearfix.col-md-1
                  label.display-block 09:00
                  input.form-control.new-02(type='text', placeholder='09:00')
                .form-group.clearfix.col-md-1
                  label.display-block 10:00
                  input.form-control.new-03(type='text', placeholder='10:00')
                .form-group.clearfix.col-md-1
                  label.display-block 11:00
                  input.form-control.new-04(type='text', placeholder='11:00')
                .form-group.clearfix.col-md-1
                  label.display-block 12:00
                  input.form-control.new-05(type='text', placeholder='12:00')
                .form-group.clearfix.col-md-1
                  label.display-block 01:00
                  input.form-control.new-06(type='text', placeholder='01:00')
                .form-group.clearfix.col-md-1
                  label.display-block 02:00
                  input.form-control.new-07(type='text', placeholder='02:00')
                .form-group.clearfix.col-md-1
                  label.display-block 03:00
                  input.form-control.new-08(type='text', placeholder='03:00')
                .form-group.clearfix.col-md-1
                  label.display-block 04:00
                  input.form-control.new-09(type='text', placeholder='04:00')
                .form-group.clearfix.col-md-1
                  label.display-block 05:00
                  input.form-control.new-10(type='text', placeholder='05:00')
                .form-group.clearfix.col-md-1
                  label.display-block 06:00
                  input.form-control.new-11(type='text', placeholder='06:00')
                .form-group.clearfix.col-md-1
                  label.display-block 07:00
                  input.form-control.new-12(type='text', placeholder='07:00')                
                .form-group.col-md-12
                  button.btn.btn-sm.btn-success.pull-right(type='submit') Add Data
        .panel.panel-default.update-panel(style='display:none;')
          .panel-heading
            | UPDATE DATA
          .panel-body
            form.update-form
              input(type = 'hidden').olddate
              input(type = 'hidden').oldname
              input(type = 'hidden').oldbuyer
              input(type = 'hidden').oldorder
              input(type = 'hidden').oldcolor
              .row
                .form-group.clearfix.col-md-2
                  label.display-block Name
                  input.form-control.update-name(type='text', placeholder='Name')
                .form-group.clearfix.col-md-2
                  label.display-block DATE
                  input.form-control.update-date(type='text', placeholder='Please choose a date...', data-format='YYYY-MM-DD')
                .form-group.clearfix.col-md-2
                  label.display-block Buyer
                  select.select-bar.update-buyer(style='width:100%;')
                    option(value='-1') Not Selected
                    - for (var i = 0; i < customers.length; i++){
                        option(value='#{customers[i].id}') #{customers[i].name}
                    - }
                .form-group.clearfix.col-md-2
                  label.display-block FILE#
                  select.select-bar.update-order(style='width: 100%;')
                    option(value='-1') Not Selected
                    - for(var i = 0; i < orders.length; i++){
                        option(value = '#{orders[i].id}') #{orders[i].name}
                    - }
                .form-group.clearfix.col-md-2
                  label.display-block COLOR
                  select.select-bar.update-color(style='width: 100%;')
                    option(value='-1') Not Selected
                    - for(var i = 0; i < colors.length; i++){
                        option(value = '#{colors[i].name}') #{colors[i].name}
                    - }                
                .col-md-2(style="position: block; width:100%;")
                .form-group.clearfix.col-md-1
                  label.display-block 08:00
                  input.form-control.update-01(type='text', placeholder='08:00')
                .form-group.clearfix.col-md-1
                  label.display-block 09:00
                  input.form-control.update-02(type='text', placeholder='09:00')
                .form-group.clearfix.col-md-1
                  label.display-block 10:00
                  input.form-control.update-03(type='text', placeholder='10:00')
                .form-group.clearfix.col-md-1
                  label.display-block 11:00
                  input.form-control.update-04(type='text', placeholder='11:00')
                .form-group.clearfix.col-md-1
                  label.display-block 12:00
                  input.form-control.update-05(type='text', placeholder='12:00')
                .form-group.clearfix.col-md-1
                  label.display-block 01:00
                  input.form-control.update-06(type='text', placeholder='01:00')
                .form-group.clearfix.col-md-1
                  label.display-block 02:00
                  input.form-control.update-07(type='text', placeholder='02:00')
                .form-group.clearfix.col-md-1
                  label.display-block 03:00
                  input.form-control.update-08(type='text', placeholder='03:00')
                .form-group.clearfix.col-md-1
                  label.display-block 04:00
                  input.form-control.update-09(type='text', placeholder='04:00')
                .form-group.clearfix.col-md-1
                  label.display-block 05:00
                  input.form-control.update-10(type='text', placeholder='05:00')
                .form-group.clearfix.col-md-1
                  label.display-block 06:00
                  input.form-control.update-11(type='text', placeholder='06:00')
                .form-group.clearfix.col-md-1
                  label.display-block 07:00
                  input.form-control.update-12(type='text', placeholder='07:00')                
                .form-group.col-md-12
                  button.btn.btn-sm.btn-success.pull-right(type='submit') Update Data
                  - for(var qqqq = 0; qqqq < role.length; qqqq++){
                    - if(role[qqqq].page == 21 && role[qqqq].d == 1){
                        .btn.btn-sm.btn-success.pull-right.remove(style='margin-right: 20px;') Remove Data
                    - }
                  - }
    - }
  - }
  .panel.panel-default.inspection-list-panel
    .panel-body
      .align-justify
        - for(var ppp = 0; ppp < role.length; ppp++){
          - if(role[ppp].page == 21 && role[ppp].w == 1){
              .p-b-10
                button.btn.btn-sm.btn-success.add-data
                  i.fa.fa-plus.m-r-5
                  | Add New Data
          - }
        - }
      table.table.table-striped.table-hover.inspection-table
        thead
          tr
            th DATE
            th Name
            th Buyer
            th File#
            th Color
            th 08:00
            th 09:00
            th 10:00
            th 11:00
            th 12:00
            th 01:00
            th 02:00
            th 03:00
            th 04:00
            th 05:00
            th 06:00
            th 07:00
            th Total
        tbody
      hr
      table.table.table-striped.table-hover.total-table(style='display:none; margin-top: 30px;')
        thead
          tr
            th Total
            th Buyer
            th 08:00
            th 09:00
            th 10:00
            th 11:00
            th 12:00
            th 01:00
            th 02:00
            th 03:00
            th 04:00
            th 05:00
            th 06:00
            th 07:00
            th Total
        tbody
block script2
  script.
    var orders = (!{JSON.stringify(orders)}), lines = (!{JSON.stringify(lines)}), customers = (!{JSON.stringify(customers)}), colors = (!{JSON.stringify(colors)});
    var init = function(){
      $('.inspection-table').DataTable({
        "pageLength": 50,
        "order": [[ 0, "asc" ], [ 1, "asc" ], [ 2, "asc" ]],
        responsive: true,        
        dom: '<"html5buttons"B>lTfgtip',
        buttons: ['copy', 'csv', 'excel', 'pdf', 'print']
      });

      $('.select-bar').select2();
      $(".new-date").datetimepicker({
        format: 'YYYY-MM-DD',
        showClear: true
      });
      $(".update-date").datetimepicker({
        format: 'YYYY-MM-DD',
        showClear: true
      });

      $('.add-panel').on('click', 'a.panel-close', function () {
        $(this).parents('.add-panel').fadeOut();
      });
      $('.update-panel').on('click', 'a.panel-close', function () {
        $(this).parents('.update-panel').fadeOut();
      });
      $('.add-data').on('click', function(){
        $('.add-panel').fadeIn();
        $('.update-panel').fadeOut();
      })
    }
    init();

    $('.add-form').submit(function(e){
      e.preventDefault();
      if($('.new-name').val() == ''){
        alert('Please chooes Name.');
        return;
      }else if($('.new-buyer').val() == -1){
        alert('Please choose Buyer.');
        return;
      }else if($('.new-order').val() == -1){
        alert('Please choose Order.');
        return;
      }else if($('.new-date').val() == ''){
        alert('Please choose Date.');
        return;
      }
      $.ajax({
        url: '/dashboard/inspection/add',
        type: 'POST',
        data: {
          name: $('.new-name').val(),
          buyer: $('.new-buyer').val(),
          order: $('.new-order').val(),
          date: $('.new-date').val(),
          color: $('.new-color').val(),
          n1: $('.new-01').val(),
          n2: $('.new-02').val(),
          n3: $('.new-03').val(),
          n4: $('.new-04').val(),
          n5: $('.new-05').val(),
          n6: $('.new-06').val(),
          n7: $('.new-07').val(),
          n8: $('.new-08').val(),
          n9: $('.new-09').val(),
          n10: $('.new-10').val(),
          n11: $('.new-11').val(),
          n12: $('.new-12').val(),
        },
        success: function(result){
          if(result.isSuccess){
            $('.search-form').submit();            
            //refreshEvent();
            reset();
          }else{
            alert('Same Name&Buyer&Order&Date is exist. Please check detail.');
          }
        }
      })
    })

    var row;
    var refreshEvent = function(){
      $('.inspection-table tbody tr').off();
      $('.inspection-table tbody tr').on('click', function(){
        row = $(".inspection-table").DataTable().row($(this));
        if($($(this).find('td')[0]).html() == 'All') return;
        let date =  $($(this).find('td')[0]).html();        
        let name =  $($(this).find('td')[1]).html();
        $('.oldname').val(name);
        $('.update-name').val(name);
        
        let order =  $($(this).find('td')[3]).html();        
        for(var i = 0; i < orders.length; i++){
          if(orders[i].name == order){
            $('.update-order').val(orders[i].id).trigger('change');
            $('.oldorder').val(orders[i].id);
          }
        }
        let buyer = $($(this).find('td')[2]).html();
        for(var i = 0; i < customers.length; i++){
          if(buyer == customers[i].name){
            $('.update-buyer').val(customers[i].id).trigger('change');
            $('.oldbuyer').val(customers[i].id);
          }
        }
        let color = $($(this).find('td')[4]).html();
        $('.update-color').val(color == ""?"-1":color).trigger('change');
        $('.oldcolor').val(color == ""?"-1":color);

        $('.update-01').val($($(this).find('td')[5]).html());
        $('.update-02').val($($(this).find('td')[6]).html());
        $('.update-03').val($($(this).find('td')[7]).html());
        $('.update-04').val($($(this).find('td')[8]).html());
        $('.update-05').val($($(this).find('td')[9]).html());
        $('.update-06').val($($(this).find('td')[10]).html());
        $('.update-07').val($($(this).find('td')[11]).html());
        $('.update-08').val($($(this).find('td')[12]).html());
        $('.update-09').val($($(this).find('td')[13]).html());
        $('.update-10').val($($(this).find('td')[14]).html());
        $('.update-11').val($($(this).find('td')[15]).html());
        $('.update-12').val($($(this).find('td')[16]).html());
        $('.update-date').val($($(this).find('td')[0]).html());
        $('.olddate').val($($(this).find('td')[0]).html());
        $('.update-panel').fadeIn();
        $('.add-panel').fadeOut();
      });      
    }
    $('.inspection-table').on( 'draw.dt', function () {
        refreshEvent();
    } );

    var alllist;
    $('.search-form').submit(function(e){
      e.preventDefault();
      $.ajax({
        url: '/dashboard/inspection/list',
        type: 'POST',
        data: {
          buyer: $('.buyer').val(),
          color: $('.color').val(),
          file: $('.style').val(),
          date: $('.in-date').val()
        },
        success: function(data){          
          if(data.isSuccess){
            var startdate = $('.in-date').val().split('-')[0].replace(new RegExp('/', 'g'), '-').replace(/\s/g, '');
            var enddate = $('.in-date').val().split('-')[1].replace(new RegExp('/', 'g'), '-').replace(/\s/g, '');
            data.list = data.list.filter(v => {              
              return (new Date(v.date.toString()) >= new Date(startdate.toString()) && new Date(v.date) <= new Date(enddate.toString()))
            })            
            
            alllist = data.list;
            var tableData = [];
            var tot = [], sum = 0, buyerdata = {};
            for(var i = 0; i < data.list.length; i++){
              var ordername, linename, buyername;
              for(var j = 0; j < orders.length; j++){
                if(orders[j].id == data.list[i].orderid)
                  ordername = orders[j].name;
              }
              //- for(var j = 0; j < lines.length; j++){
              //-   if(lines[j].id == data.list[i].line){
              //-     linename = lines[j].name;
              //-     break;
              //-   }
              //- }
              for(var j = 0; j < customers.length; j++){
                if(customers[j].id == data.list[i].buyer){
                  buyername = customers[j].name;
                  break;
                }
              }
              if (buyerdata[buyername] == undefined) {
                buyerdata[buyername] = {};
                for(var j = 1; j < 13; j++){
                  buyerdata[buyername]['n'+j] = 0;
                }
                buyerdata[buyername]['sum'] = 0;
              }
              var total = 0, balance;
              for(var j = 1; j < 13; j++){
                total += Number(data.list[i]['n'+j]);
                // For final Row
                if(tot['n'+j] == undefined) tot['n'+j] = 0;
                tot['n'+j] += Number(data.list[i]['n'+j]);                
                sum += Number(data.list[i]['n'+j]);
                buyerdata[buyername]['n'+j] += Number(data.list[i]['n'+j]);
                buyerdata[buyername]['sum'] += Number(data.list[i]['n'+j]);
                // 
              }
              tableData.push([
                data.list[i].date, data.list[i].name, buyername, ordername, data.list[i].color == "-1"? "": data.list[i].color, data.list[i].n1, data.list[i].n2, data.list[i].n3, data.list[i].n4,
                data.list[i].n5, data.list[i].n6, data.list[i].n7, data.list[i].n8, data.list[i].n9, data.list[i].n10, data.list[i].n11, data.list[i].n12,
                total
              ]);
            }            
            $('.inspection-table').dataTable().fnClearTable();
            if(tableData.length > 0){
              $('.inspection-table').dataTable().fnAddData(tableData);
              $('.inspection-table').dataTable().fnDraw();

              var ht = ``;
              for (var key in buyerdata) {
                ht += `<tr><td/><td>`+key+`</td><td>`+buyerdata[key]['n1']+`<td>`+buyerdata[key]['n2']+`</td><td>`+buyerdata[key]['n3']+`</td><td>`+buyerdata[key]['n4']+`</td><td>`
                +buyerdata[key]['n5']+`</td><td>`+buyerdata[key]['n6']+`</td><td>`+buyerdata[key]['n7']+`</td><td>`+buyerdata[key]['n8']+`</td><td>`+buyerdata[key]['n9']+`</td><td>`
                +buyerdata[key]['n10']+`</td><td>`+buyerdata[key]['n11']+`</td><td>`+buyerdata[key]['n12']+`</td><td>`+buyerdata[key]['sum']+`</td></tr>`;
              }
              ht += `<tr><td>Total</td><td/><td>`+tot['n1']+`</td><td>`+tot['n2']+`</td><td>`+tot['n3']+`</td><td>`+tot['n4']+`</td><td>`+tot['n5']+`</td><td>`+tot['n6']+`</td><td>`+tot['n7']
              +`</td><td>`+tot['n8']+`</td><td>`+tot['n9']+`</td><td>`+tot['n10']+`</td><td>`+tot['n11']+`</td><td>`+tot['n12']+`</td><td>`+sum+`</td>`;
              $('.total-table tbody').html(ht);
              $('.total-table').show();
            } else {
              $('.total-table').hide();
            }
            console.log(buyerdata);
          }else{
            alert('Cannot load list. Please contact support team.');
          }
        }
      })
    })

    $('.update-form').submit(function(e){
      e.preventDefault();
      if($('.update-name').val() == -1){
        alert('Please chooes name.');
        return;
      }else if($('.update-buyer').val() == -1){
        alert('Please choose Buyer.');
        return;
      }else if($('.update-order').val() == -1){
        alert('Please choose Order.');
        return;
      }else if($('.update-date').val() == ''){
        alert('Please choose Date.');
        return;
      }
      $.ajax({
        url: '/dashboard/inspection/update',
        type: 'POST',
        data: {
          oldname: $('.oldname').val(),
          oldbuyer: $('.oldbuyer').val(),
          oldorder: $('.oldorder').val(),
          olddate: $('.olddate').val(),
          oldcolor: $('.oldcolor').val(),
          name: $('.update-name').val(),
          buyer: $('.update-buyer').val(),
          order: $('.update-order').val(),
          date: $('.update-date').val(),
          color: $('.update-color').val(),
          n1: $('.update-01').val(),
          n2: $('.update-02').val(),
          n3: $('.update-03').val(),
          n4: $('.update-04').val(),
          n5: $('.update-05').val(),
          n6: $('.update-06').val(),
          n7: $('.update-07').val(),
          n8: $('.update-08').val(),
          n9: $('.update-09').val(),
          n10: $('.update-10').val(),
          n11: $('.update-11').val(),
          n12: $('.update-12').val(),
        },
        success: function(result){
          if(result.isSuccess){
            $('.search-form').submit();            
            $('.update-panel').fadeOut();
            //refreshEvent();
          }else{
            alert('Cannot update data. Please contact support team.')
          }
        }
      });
    })

    $('.remove').on('click', function(){
      $.ajax({
        url: '/dashboard/inspection/remove',
        type: 'POST',
        data: {
          oldname: $('.oldname').val(),
          oldbuyer: $('.oldbuyer').val(),
          oldorder: $('.oldorder').val(),
          olddate: $('.olddate').val(),
          oldcolor: $('.oldcolor').val()
        },
        success: function(result){
          if(result.isSuccess){
            row.remove();
            $('.search-form').submit();
            $('.inspection-table').dataTable().fnDraw();
            $('.update-panel').fadeOut();
          }else{
            alert('Cannot remove. Please contact support team.')
          }
        }
      })
    })

    var reset = function(){
      $('.new-date').val('');      
      $('.new-color').val('');
      $('.new-01').val('');
      $('.new-02').val('');
      $('.new-03').val('');
      $('.new-04').val('');
      $('.new-05').val('');
      $('.new-06').val('');
      $('.new-07').val('');
      $('.new-08').val('');
      $('.new-09').val('');
      $('.new-10').val('');
      $('.new-11').val('');
      $('.new-12').val('');      
    }