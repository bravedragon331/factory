extends ../layout
block link
  // Bootstrap DateRangePicker Css
  link(href='/assets/plugins/bootstrap-daterangepicker/daterangepicker.css', rel='stylesheet')
block content  
  section.content
    block page-header  
    .page-body
      .panel.panel-default
        .panel-body
          form.form-horizontal.search-form
            .form-group.has-feedback
              .col-md-2
                label Buyer
                select.form-control.buyer(data-placeholder='Select buyer...', style='width: 100%;')
                  option(value='-1') Not Selected
                  - for (var i = 0; i < customers.length; i++){
                      option(value='#{customers[i].id}') #{customers[i].name}
                  - }
              .col-md-2
                label Date
                input.form-control.date(type='text')
                span.glyphicon.glyphicon-calendar.form-control-feedback
              .col-md-2
                label Order
                select.form-control.order(data-placeholder='Input color name or select...', style='width: 100%;')
                  option(value='-1') Not Selected
                  - for(var i = 0; i < orders.length; i++){
                      option(value='#{orders[i].code}') #{orders[i].name}
                  - }
              .col-md-2
                label Color
                select.form-control.color(data-placeholder='Input color name or select...', style='width: 100%;')
                  option(value='-1') Not Selected
                  - for(var i = 0; i < colors.length; i++){
                      option(value='#{colors[i].code}') #{colors[i].name}
                  - }
              .col-md-2
                label Style
                input.form-control.style(type='text', placeholder='Style#')              
              .col-md-1
                button.btn.btn-success.pull-right(type='submit', style='margin-top: 28px; width: 100%;')
                  i.fa.fa-search
                  |  Search
      .panel.panel-default
        .panel-body
          table.table.table-bordered.table-striped.main-table
            thead
              tr
                th(rowspan='2' colspan='2' width='50').text-center ORDER#
                th(rowspan='2' colspan='2' width='50').text-center STYLE
                th(rowspan='2' colspan='2' width='50').text-center PO
                th(rowspan='2' colspan='2' width='50').text-center COLOR
                th(rowspan='2' colspan='2' width='50').text-center SIZE
                th(rowspan='1' colspan='6' width='250').text-center ORDER Q'TY
                th(rowspan='1' colspan='3' width='150').text-center CUTTING
                th(rowspan='1' colspan='6' width='300').text-center SEWING
              tr
                th(width='50').text-center.date1
                th(width='50').text-center.date2
                th(width='50').text-center.date3
                th(width='50').text-center.date4
                th(width='50').text-center.date5
                th(width='50').text-center TOTAL
                th(width='50').text-center TODAY
                th(width='50').text-center TOTAL
                th(width='50').text-center BALACNE
                th(width='50').text-center TODAY
                th(width='50').text-center TOTAL
                th(width='50').text-center BALANCE
                th(width='50').text-center SEGUNDAS
                th(width='50').text-center DEFECTOS
                th(width='50').text-center F/S/C/PR
block script  
  script(src='/assets/plugins/moment/moment.js')
  script(src='/assets/plugins/bootstrap-daterangepicker/daterangepicker.js')  
  
  // Colorpicker Js
  script(src='/assets/plugins/bootstrap-colorpicker/dist/js/bootstrap-colorpicker.min.js')
  script(src='/assets/plugins/eonasdan-bootstrap-datetimepicker/src/js/bootstrap-datetimepicker.js')

  script.
    $('.buyer').select2();
    $('.color').select2();
    $('.order').select2();

    $(".date").datetimepicker({
      format: 'YYYY-MM-DD',
      showClear: true
    });
    $('.date').val(new Date().getFullYear()+'-'+("0"+(new Date().getMonth()+1)).slice(-2)+'-'+("0" + new Date().getDate()).slice(-2));

    // Left Menu
    $('.m-sew-status').addClass('active');

    $(document).ready(function() {
      var curdate = $('.date').val();
      var today = new Date(new Date(curdate).getTime() + new Date().getTimezoneOffset()*60000);
      const formatDate =  function(date) {
        var d = new Date(date),
        month = '' + (d.getMonth() + 1),
        day = '' + d.getDate(),
        year = d.getFullYear();

        if (month.length < 2) month = '0' + month;
        if (day.length < 2) day = '0' + day;

        return [year, month, day].join('-');
      }
      $.ajax({
        url: "/dashboard/sew/report/list",
        type: 'POST',
        data: {
          date: formatDate(today)
        },
        success: function(res){
          console.log(res);
          // Display Date
          for(var i = 1 ; i <= res.dates.length; i++) {
            $('.date'+i).html(res.dates[i-1]);
          }

          //Display Order
          var data = [];
          for (var i = 0; i < res.order.length; i++) {
            var b = true;
            for(var j = 0; j < data.length; j++) {
              if((data[j].order == res.order[i].order) && (data[j].style == res.order[i].style) && (data[j].color == res.order[i].color)) {
                copyData(data[j], res.order[i]);
                b = false;
              }
            }
            if(b) {
              data.push(res.order[i]);
            }
          }

          // Cut Data is ready.
          cut = res.cut;
          for(var i = 0; i < data.length; i++) {
            var to_value = {}, ta_value = {};
            for(var j = 0; j < cut.length; j++) {
              if((data[i].order == cut[j].orderid) && (data[i].style == cut[j].style) && (data[i].color == cut[j].colorname)) {
                if(cut.cutdate == $('.date').val()) {
                  for(var k = 1; k < 11; k++) {
                    to_value['size'+k] = (to_value['size'+k]?to_value['size'+k]:0) + (cut[j]['size'+k]?Number(cut[j]['size'+k]):0);
                  }
                }
              }
              for(var k = 1; k < 11; k++) {
                ta_value['size'+k] = (ta_value['size'+k]?ta_value['size'+k]:0) + (cut[j]['size'+k]?Number(cut[j]['size'+k]):0);
              }
            }
            data[i].to_value = to_value;
            data[i].ta_value = ta_value;
          }
          
          // Display Data.
          var ht = '', b = [];
          for(var i = 0; i < data.length; i++) {
            b[i] = true;
            for(var j = 0; j < data.length; j++) {
              if(b[j] == true) continue;              
            }
          }
        }
      })
    })

    var copyData = function(dest, data) {
      for(var i = 0; i < 5; i++) {
        for(var j = 1; j < 10; j++) {
          dest['date'+i]['size'+j] = (dest['date'+i]['size'+j]?dest['date'+i]['size'+j]:0) + (data['date'+i]['size'+j]?data['date'+i]['size'+j]:0);
        }
      }
    }      