extends ./layout
block page-body
  .panel.panel-default.order-panel
    .panel-body
      h4 Order List
      table.table.table-bordered.table-striped.table-hover.js-basic-example.order-table.dataTable
        thead
          tr
            th Date
            th Handler
            th File#
            th Buyer
            th Style
            th Product
            th Season
            th Quantity
        tbody
  .panel.panel-default.fabric-panel(style='display:none;')
    .row.clearfix
      .col-xs-12.col-sm-12.col-md-12.col-lg-12
        ul.nav.nav-tabs.bg-default
        .tab-content
          #tab_.tab-pane.fade.in.active(role='tabpanel')
            .panel.panel-default.add-fabric
              .panel-heading Add Fabric Out
              .panel-body
                form.add-form
                  .form-group.clearfix.col-md-2
                    label.display-block Task PO
                    select.add-task-bar.add-select2(style='width: 100%;')
                      option(value='-1') Not Selected                  
                  .form-group.clearfix.col-md-2
                    label.display-block Color
                    select.add-color-bar.add-select2(style='width: 100%;')
                      option(value='-1') Not Selected
                  .form-group.clearfix.col-md-2
                    label.display-block Fabric Type
                    select.add-fabric-type-bar.add-select2(style='width: 100%;')
                      option(value='-1') Not Selected
                  //- .form-group.clearfix.col-md-2
                  //-   label.display-block Fabric
                  //-   select.add-fabric-bar.add-select2(style='width: 100%;')
                  //-     option(value='-1') Not Selected                  
                  .form-group.clearfix.col-md-2
                    label.display-block KG
                    input.form-control.add-kg(type='text', placeholder='')
                  .form-group.clearfix.col-md-2
                    label.display-block Out(Yds)
                    input.form-control.add-yds(type='text', placeholder='')
                  .form-group.clearfix.col-md-2
                    label.display-block Out(Roll)
                    input.form-control.add-roll(type='text', placeholder='')
                  .form-group.clearfix.col-md-2
                    label.display-block Date
                    input.form-control.add-in-date(type='text', placeholder='Out Date', data-format='YYYY-MM-DD')
                  .form-group.clearfix.col-md-2
                    label.display-block Department
                    select.add-customer-bar.add-select2(style='width: 100%;')
                      option(value='-1') Not Selected
                      - for(var i = 0; i < allcustomers.length; i++){
                        option(value = '#{allcustomers[i].id}') #{allcustomers[i].name}
                      - }
                  .form-group.clearfix.col-md-2
                    label.display-block Rcvd
                    input.form-control.add-rcvd(type='text', placeholder='Rcvd', required='')
                  //- .form-group.clearfix.col-md-2
                  //-   label.display-block Rib
                  //-   input.form-control.add-rib(type='text', placeholder='Rib')
                  .form-group.clearfix.col-md-2
                    label.display-block Rechazo
                    input.form-control.add-rechazo(type='text', placeholder='Rechazo')
                  .form-group.clearfix.col-md-2
                    label.display-block Return
                    input.form-control.add-return(type='text', placeholder='Return')
                  .form-group.clearfix.col-md-2
                    label.display-block Bad(Warehouse)
                    input.form-control.add-bad(type='text', placeholder='Bad')
                  .form-group.clearfix.col-md-2
                    label.display-block Note
                    input.form-control.add-note(type='text', placeholder='Note')
                  .form-group.clearfix.col-md-12
                    button.btn.btn-sm.btn-success.pull-right(type='submit') Add Fabric Out

            - for(var ppp = 0; ppp < role.length; ppp++){
              - if(role[ppp].page == 2 && role[ppp].w == 1){
                  .panel.panel-default.update-fabric
                    .panel-heading Update Fabric Out
                    .panel-body
                      form.update-form
                        input.old-po(type='hidden')
                        input.old-fabric(type='hidden')
                        input.old-fabrictype(type='hidden')
                        input.old-color(type='hidden')
                        .form-group.clearfix.col-md-2
                          label.display-block Task PO
                          select.update-task-bar.update-select2(style='width: 100%;')
                            option(value='-1') Not Selected                  
                        .form-group.clearfix.col-md-2
                          label.display-block Color
                          select.update-color-bar.update-select2(style='width: 100%;')
                            option(value='-1') Not Selected
                        .form-group.clearfix.col-md-2
                          label.display-block Fabric Type
                          select.update-fabric-type-bar.update-select2(style='width: 100%;')
                            option(value='-1') Not Selected
                        //- .form-group.clearfix.col-md-2
                        //-   label.display-block Fabric
                        //-   select.update-fabric-bar.update-select2(style='width: 100%;')
                        //-     option(value='-1') Not Selected                  
                        .form-group.clearfix.col-md-2
                          label.display-block KG
                          input.form-control.update-kg(type='text', placeholder='')
                        .form-group.clearfix.col-md-2
                          label.display-block Out(Yds)
                          input.form-control.update-yds(type='text', placeholder='')
                        .form-group.clearfix.col-md-2
                          label.display-block Out(Roll)
                          input.form-control.update-roll(type='text', placeholder='')
                        .form-group.clearfix.col-md-2
                          label.display-block Date
                          input.form-control.update-in-date(type='text', placeholder='Out Date', data-format='YYYY-MM-DD')
                        .form-group.clearfix.col-md-2
                          label.display-block Department
                          select.update-customer-bar.update-select2(style='width: 100%;')
                            option(value='-1') Not Selected
                            - for(var i = 0; i < allcustomers.length; i++){
                              option(value = '#{allcustomers[i].id}') #{allcustomers[i].name}
                            - }
                        .form-group.clearfix.col-md-2
                          label.display-block Rcvd
                          input.form-control.update-rcvd(type='text', placeholder='Rcvd', required='', readonly)
                        //- .form-group.clearfix.col-md-2
                        //-   label.display-block Rib
                        //-   input.form-control.update-rib(type='text', placeholder='Rib')
                        .form-group.clearfix.col-md-2
                          label.display-block Rechazo
                          input.form-control.update-rechazo(type='text', placeholder='Rechazo')
                        .form-group.clearfix.col-md-2
                          label.display-block Return
                          input.form-control.update-return(type='text', placeholder='Return')
                        .form-group.clearfix.col-md-2
                          label.display-block Bad(Warehouse)
                          input.form-control.update-bad(type='text', placeholder='Bad')
                        .form-group.clearfix.col-md-2
                          label.display-block Note
                          input.form-control.update-note(type='text', placeholder='Note')
                        .form-group.clearfix.col-md-12
                          button.btn.btn-sm.btn-success.pull-right(type='submit') Update Fabric
              - }
            - }
            
            .panel.panel-default
              - for(var ppp = 0; ppp < role.length; ppp++){
                - if(role[ppp].page == 2 && role[ppp].w == 1){
                    .panel-heading
                
                      button.btn.btn-sm.btn-success.new-button
                        i.fa.fa-plus.m-r-5
                        | Add New Out
                - }
              - }                
              .panel-body
                table.table.table-striped.table-hover.js-exportable.fabric-table
                  thead
                    tr
                      th Date
                      th P.O
                      th Fabric Type
                      th Rcvd
                      th Width
                      th Body
                      th Color
                      th KG
                      th Out(Yds)
                      th Out(Roll)
                      th Department
                      th Rechazo
                      
                      th Return
                      th Bad(Warehouse)
                      th Note
                  tbody
            
block script2
  script.
    var fabrics = (!{JSON.stringify(fabric)}), tasks, orderfabrics, orderftypes, fabric, allcustomers = (!{JSON.stringify(allcustomers)}), buyer;
    $('.search-form').submit(function(e){
      e.preventDefault();
      var startdate = $('.in-date').val().split('-')[0];
      var enddate = $('.in-date').val().split('-')[1];

      $.ajax({
        url: '/dashboard/fabric/search',
        type: 'POST',
        data: {
          buyer: $('.buyer').val(),
          startdate: startdate,
          enddate: enddate,
          fabric_type: $('.fabric-type').val(),
          fabric: $('.fabric').val(),
          color: $('.color').val(),
          po: $('.po').val(),
          style: $('.style').val()
        },
        success: function(result){
          if(result.isSuccess){
            console.log(result.list);
            fillOrderTable(result.list);
          }else{
            alert('Cannot search.');
          }
        }
      })
    })

    $('.order-panel').hide();

    var fillOrderTable = function(list){
      $('.order-panel').show();
      var tableData = [];
      for(let i = 0; i < list.length; i++){
        tableData.push([
          list[i].date.split('T')[0], list[i].handlername, list[i].name, list[i].buyername, list[i].style, list[i].product, list[i].season, list[i].quantity
        ])
      }
      $('.order-table').dataTable().fnClearTable();
      if(tableData.length > 0){
        $('.order-table').dataTable().fnAddData(tableData);
        $('.order-table').dataTable().fnDraw();
      }
      refreshEvent();
    }

    var style, ordername;
    var refreshEvent = function(){
      $('.order-table tbody tr').off();
      $('.order-table tbody tr').on('click', function(){
        ordername = $($(this).find('td')[2]).html();        
        buyer =  $($(this).find('td')[3]).html();                
        style = $($(this).find('td')[4]).html();
        $.ajax({
          url: '/dashboard/fabric/order_fabric',
          type: 'POST',
          data: {
            name: ordername,
            buyer: buyer
          },
          success: function(data){
            if(data.isSuccess){
              console.log(data);
              orderfabrics = data.fabrics.fabrics;
              orderftypes = data.fabrics.ftypes;

              //Add-Form
              /*
              $(".add-fabric-bar").select2("destroy");
              $('.add-fabric-bar').html("");
              $('.add-fabric-bar').append(
                  '<option value="-1">Not Selected</option>'
              );              
              $.each(orderfabrics, function(index, value) {
                $('.add-fabric-bar').append(
                  '<option value="' + orderfabrics[index].id + '">' + orderfabrics[index].name + '</option>'
                );
              });
              $(".add-fabric-bar").select2();
              */

              $(".add-fabric-type-bar").select2("destroy");
              $('.add-fabric-type-bar').html("");
              $('.add-fabric-type-bar').append(
                  '<option value="-1">Not Selected</option>'
              );              
              $.each(orderftypes, function(index, value) {
                $('.add-fabric-type-bar').append(
                  '<option value="' + orderftypes[index].id + '">' + orderftypes[index].name + '</option>'
                );
              });
              $(".add-fabric-type-bar").select2();

              //Update-Form
              /*
              $(".update-fabric-bar").select2("destroy");
              $('.update-fabric-bar').html("");
              $('.update-fabric-bar').append(
                  '<option value="-1">Not Selected</option>'
              );              
              $.each(orderfabrics, function(index, value) {
                $('.update-fabric-bar').append(
                  '<option value="' + orderfabrics[index].id + '">' + orderfabrics[index].name + '</option>'
                );
              });
              $(".update-fabric-bar").select2();
              */

              $(".update-fabric-type-bar").select2("destroy");
              $('.update-fabric-type-bar').html("");
              $('.update-fabric-type-bar').append(
                  '<option value="-1">Not Selected</option>'
              );              
              $.each(orderftypes, function(index, value) {
                $('.update-fabric-type-bar').append(
                  '<option value="' + orderftypes[index].id + '">' + orderftypes[index].name + '</option>'
                );
              });
              $(".update-fabric-type-bar").select2();

              //Tab Nav Menu
              var ht = '';
              for(var i = 0; i < orderfabrics.length; i++){
                for(var j = 0; j < fabrics.length; j++){
                  if(orderfabrics[i].id == fabrics[j].id){
                    ht += '<li role="presentation">';
                    ht += '<a href = "#tab_'+'", data-toggle="tab", data-fabric="'+orderfabrics[i].id+'", data-buyer="'+buyer+'" class="tab_'+i+'">'+fabrics[j].name+'</a>';
                    ht += '</li>';
                  }
                }
              }
              $('.nav-tabs').html(ht);
              refreshTabEvent();
            }else{
              alert('Cannot load Fabric list.');
            }
          }
        });
      });
    }

    //Add Form    
    $('.add-select2').select2();
    $('.update-select2').select2();
    //In-Date
    $(".add-in-date").datetimepicker({
      format: 'YYYY-MM-DD',
      showClear: true
    });
    $(".update-in-date").datetimepicker({
      format: 'YYYY-MM-DD',
      showClear: true
    });
    
    var refreshTabEvent = function(){
      $('.fabric-panel').show();
      $.ajax({
        url: '/dashboard/fabric/orderdetail',
        type: 'POST',
        data: {
          ordername: ordername
        },
        success: function(data){
          if(data.isSuccess){
            console.log(data.list);
            //Add-Form
            $(".add-task-bar").select2("destroy");
            $('.add-task-bar').html("");
            $('.add-task-bar').append(
                '<option value="-1">Not Selected</option>'
            );              
            tasks = data.list;
            var tmp = [];
            for(var index = 0; index < tasks.length; index++) {
              if(!tmp.includes(tasks[index].po)){
                $('.add-task-bar').append(
                  '<option value="' + tasks[index].po + '">' + tasks[index].po + '</option>'
                );
                tmp.push(tasks[index].po);
              }
            };
            $(".add-task-bar").select2();

            //Update-Form
            $(".update-task-bar").select2("destroy");
            $('.update-task-bar').html("");
            $('.update-task-bar').append(
                '<option value="-1">Not Selected</option>'
            );              
            tasks = data.list;
            var tmp = [];
            for(var index = 0; index < tasks.length; index++) {
              if(!tmp.includes(tasks[index].po)){
                $('.update-task-bar').append(
                  '<option value="' + tasks[index].po + '">' + tasks[index].po + '</option>'
                );
                tmp.push(tasks[index].po);
              }
            };
            $(".update-task-bar").select2();

            refreshTaskChangeEvent();
            //Hide form
            $('.add-fabric').hide();
            $('.update-fabric').hide();
            
          }else{
            alert('Cannot load Tasks.');
          }
        }
      })

      $('a[data-toggle="tab"]').off();
      $('a[data-toggle="tab"]').on('click', function(){
        fabric = $(this).data('fabric');
        refreshFabricTableEvent();
      });
    }

    var refreshTaskChangeEvent = function(){
      //Add-Form
      $('.add-task-bar').on('change', function(){        
        //Add-Form
        $(".add-color-bar").select2("destroy");
        $('.add-color-bar').html("");
        $('.add-color-bar').append(
            '<option value="-1">Not Selected</option>'
        );

        for(var i = 0; i < tasks.length; i++){
          if(tasks[i].po == $(this).val()){
            $('.add-color-bar').append(
              '<option value="'+tasks[i].color+'">'+tasks[i].colorname+'</option>'
            );
          }
        }
        $(".add-color-bar").select2();
      })
      //Update-Form
      $('.update-task-bar').on('change', function(){
        $(".update-color-bar").select2("destroy");
        $('.update-color-bar').html("");
        $('.update-color-bar').append(
            '<option value="-1">Not Selected</option>'
        );

        for(var i = 0; i < tasks.length; i++){
          if(tasks[i].po == $(this).val()){
            $('.update-color-bar').append(
              '<option value="'+tasks[i].color+'">'+tasks[i].colorname+'</option>'
            );
          }
        }
        $(".update-color-bar").select2();
      })

      //Select first tab
      $('.tab_0').click();
    }
    
    $('.add-fabric').on('click', 'a.panel-close', function () {
      $(this).parents('.add-fabric').fadeOut();
    });
    $('.update-fabric').on('click', 'a.panel-close', function () {
      $(this).parents('.update-fabric').fadeOut();
    });
    $('.new-button').on('click', function(){
      $('.add-fabric').show();
      $('.update-fabric').hide();
    })

    $('.add-form').submit(function(e){
      e.preventDefault();
      if($('.add-task-bar').val() == '-1'){
        alert('Please select task.');
        return;
      }else if($('.add-color-bar').val() == '-1'){
        alert('Please select color.');
        return;
      }else if($('.add-fabric-type-bar').val() == '-1'){
        alert('Please select Fabric Type');
      }else if($('.add-customer-bar').val() == '-1'){
        alert('Please select Department');
      }

      let po;
      for(var i = 0; i < tasks.length; i++){
        if(tasks[i].po == $('.add-task-bar').val() && tasks[i].color == $('.add-color-bar').val()){
          po = tasks[i].id;
        }
      }

      $.ajax({
        url: '/dashboard/fabric/fabric_out',
        type: 'POST',
        data: {
          po: po,
          color: $('.add-color-bar').val(),
          fabrictype: $('.add-fabric-type-bar').val(),
          fabric: fabric,
          rcvd: $('.add-rcvd').val(),
          kg: $('.add-kg').val(),
          yds: $('.add-yds').val(),
          roll: $('.add-roll').val(),
          date: $('.add-in-date').val(),
          customer: $('.add-customer-bar').val(),
          //rib: $('.add-rib').val(),
          rechazo: $('.add-rechazo').val(),
          return: $('.add-return').val(),
          bad: $('.add-bad').val(),
          note: $('.add-note').val()
        },
        success: function(data){
          console.log(data);
          if(data.isSuccess){            
            refreshFabricTableEvent();
          }else{
            alert('Cannot Save Fabric Out. Already same PO&Fabirc&Rcvd exist. Please check detail.')
          }
        }
      })
    })

    $('.update-form').submit(function(e){
      e.preventDefault();
      if($('.update-task-bar').val() == '-1'){
        alert('Please select task.');
        return;
      }else if($('.update-color-bar').val() == '-1'){
        alert('Please select color.');
        return;
      }else if($('.update-fabric-type-bar').val() == '-1'){
        alert('Please select Fabric Type');
      }else if($('.update-customer-bar').val() == '-1'){
        alert('Please select Department');
      }

      let po;
      for(var i = 0; i < tasks.length; i++){
        if(tasks[i].po == $('.update-task-bar').val() && tasks[i].color == $('.update-color-bar').val()){
          po = tasks[i].id;
        }
      }

      $.ajax({
        url: '/dashboard/fabric/fabric_out_update',
        type: 'POST',
        data: {
          oldpo: $('.old-po').val(),
          oldfabrictype: $('.old-fabrictype').val(),
          oldcolor: $('.old-color').val(),
          po: po,
          color: $('.update-color-bar').val(),
          fabrictype: $('.update-fabric-type-bar').val(),
          fabric: fabric,
          rcvd: $('.update-rcvd').val(),
          kg: $('.update-kg').val(),
          yds: $('.update-yds').val(),
          roll: $('.update-roll').val(),
          date: $('.update-in-date').val(),
          customer: $('.update-customer-bar').val(),
          //rib: $('.update-rib').val(),
          rechazo: $('.update-rechazo').val(),
          ret: $('.update-return').val(),
          bad: $('.update-bad').val(),
          note: $('.update-note').val()
        },
        success: function(data){
          if(data.isSuccess){            
            refreshFabricTableEvent();
            $('.update-fabric').fadeOut();
          }else{
            alert('Cannot Save Fabric Out. Already same PO&Fabirc&Rcvd exist. Please check detail..')
          }
        }
      })
    })

    
    var refreshFabricTableEvent = function(){
      $.ajax({
        url: '/dashboard/fabric/fabric_out_list',
        type: 'POST',
        data: {
          fabric: fabric,
          ordername: ordername
        },
        success: function(data){
          if(data.isSuccess){
            var tableData = [];
            for(var i = 0; i <  data.list.length; i++){
              for(var j = 0; j < allcustomers.length; j++){
                if(data.list[i].customer == allcustomers[j].id){
                  
                  tableData.push([
                    data.list[i].date, data.list[i].po, data.list[i].fabrictype, data.list[i].rcvd, data.list[i].width, data.list[i].weight, data.list[i].color, data.list[i].kg,
                    data.list[i].yds, data.list[i].roll, allcustomers[j].name, data.list[i].rechazo, /*data.list[i].rib,*/ data.list[i].ret, data.list[i].bad, data.list[i].note
                  ])
                }
              }              
            }                              
            $('.fabric-table').dataTable().fnClearTable();
            if(tableData.length > 0){
              $('.fabric-table').dataTable().fnAddData(tableData);
              $('.fabric-table').dataTable().fnDraw();
            }            
            init();            
          }else{
            alert('Cannot load Fabric Out.');
          }
        }
      });      
    }
    
    var init = function(){
      $('.add-kg').val('');
      $('.add-yds').val('');
      $('.add-roll').val('');
      $('.add-in-date').val('');      
      //$('.add-rib').val('');
      $('.add-rechazo').val('');
      $('.add-return').val('');
      $('.add-bad').val('');
      $('.add-note').val('');

      $('.update-kg').val('');
      $('.update-yds').val('');
      $('.update-roll').val('');
      $('.update-in-date').val('');      
      //$('.update-rib').val('');
      $('.update-rechazo').val('');
      $('.update-return').val('');
      $('.update-bad').val('');
      $('.update-note').val('');

      $('.fabric-table tbody tr').off();
      $('.fabric-table tbody tr').on('click', function(){
        $('.update-fabric').fadeIn();
        $('.add-fabric').fadeOut();
        row = $(".fabric-table").DataTable().row($(this));
        
        let po = $($(this).find('td')[1]).html();
        let color = $($(this).find('td')[6]).html();
        $.each(tasks, function(index, value) {
          if(po == tasks[index].po && color == tasks[index].colorname ){
            $('.update-task-bar').val(tasks[index].po).trigger('change');
            $('.old-po').val(tasks[index].id);
          }
        });

        setTimeout(function(){
          $(".update-color-bar > option").each(function() {
            if(this.text == color){
              $('.update-color-bar').val(this.value).trigger('change');
              $('.old-color').val(this.value);
            }
          });
        }, 500);

        let ftype = $($(this).find('td')[2]).html();
        $.each(orderftypes, function(index, value) {
          if(ftype == orderftypes[index].name){          
            $('.update-fabric-type-bar').val(orderftypes[index].id).trigger('change');
            $('.old-fabrictype').val(orderftypes[index].id);
          }
        });

        let buyername = $($(this).find('td')[10]).html();
        $.each(allcustomers, function(index, value) {
          if(buyername == allcustomers[index].name){          
            $('.update-customer-bar').val(allcustomers[index].id).trigger('change');            
          }
        });

        $('.update-kg').val($($(this).find('td')[7]).html());
        $('.update-yds').val($($(this).find('td')[8]).html());
        $('.update-roll').val($($(this).find('td')[9]).html());
        $('.update-rechazo').val($($(this).find('td')[11]).html());
        //$('.update-rib').val($($(this).find('td')[12]).html());
        $('.update-return').val($($(this).find('td')[12]).html());
        $('.update-bad').val($($(this).find('td')[13]).html());
        $('.update-note').val($($(this).find('td')[14]).html());
        $('.update-in-date').val($($(this).find('td')[0]).html());
        $('.update-rcvd').val($($(this).find('td')[3]).html())
      });
    }